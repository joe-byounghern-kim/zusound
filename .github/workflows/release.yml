name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      bump:
        description: Optional version override (patch, minor, major)
        required: false
        default: ''
      auth_mode:
        description: Publish auth mode (oidc or token)
        type: choice
        options:
          - oidc
          - token
        required: false
        default: oidc
      publish_only:
        description: Publish existing unpublished version without creating a new release commit
        type: boolean
        required: false
        default: true

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    if: ${{ github.event_name == 'workflow_dispatch' || !startsWith(github.event.head_commit.message, 'chore(release):') }}
    runs-on: ubuntu-latest
    environment:
      name: npm-publish
    permissions:
      contents: write
      id-token: write
      pull-requests: read
      statuses: read

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22
          cache: pnpm
          registry-url: https://registry.npmjs.org

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: README sync check
        run: pnpm readme:check

      - name: Lint
        run: pnpm lint

      - name: Typecheck
        run: pnpm typecheck

      - name: Build
        run: pnpm build

      - name: Test Coverage
        run: pnpm test:coverage

      - name: Validate manual dispatch inputs
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          if [ "${{ github.event.inputs.publish_only }}" != "true" ] && [ -z "${{ github.event.inputs.bump }}" ]; then
            echo "workflow_dispatch with publish_only=false requires bump (patch|minor|major)."
            exit 1
          fi

      - name: Prepare automatic changeset and version
        id: prepare_release
        if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.publish_only != 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.CHANGESETS_GITHUB_TOKEN != '' && secrets.CHANGESETS_GITHUB_TOKEN || github.token }}
          RELEASE_BUMP: ${{ github.event.inputs.bump }}
        run: |
          node scripts/create-auto-changeset.mjs
          pnpm version-packages
          VERSION=$(node -e "console.log(JSON.parse(require('node:fs').readFileSync('packages/zusound/package.json', 'utf8')).version)")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          if git diff --quiet; then
            echo "release_needed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "release_needed=true" >> "$GITHUB_OUTPUT"

      - name: Freshness guard
        id: freshness
        if: ${{ steps.prepare_release.outputs.release_needed == 'true' || (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_only == 'true') }}
        run: |
          git fetch origin main --tags
          HEAD_SHA=$(git rev-parse HEAD)
          MAIN_SHA=$(git rev-parse origin/main)
          if [ "$HEAD_SHA" != "$MAIN_SHA" ]; then
            echo "stale=true" >> "$GITHUB_OUTPUT"
            echo "Stale release run detected (HEAD=$HEAD_SHA, origin/main=$MAIN_SHA). Skipping publish and release commit push."
            exit 0
          fi
          echo "stale=false" >> "$GITHUB_OUTPUT"

      - name: Commit release version and tag
        if: ${{ steps.prepare_release.outputs.release_needed == 'true' && steps.freshness.outputs.stale != 'true' }}
        run: |
          VERSION="${{ steps.prepare_release.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore(release): v${VERSION}"
          git tag "v${VERSION}"
          git push origin HEAD:main
          git push origin "v${VERSION}"

      - name: Validate token fallback secret
        if: ${{ ((steps.prepare_release.outputs.release_needed == 'true' || (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_only == 'true')) && steps.freshness.outputs.stale != 'true' && github.event.inputs.auth_mode == 'token') }}
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -z "$NPM_TOKEN" ]; then
            echo "NPM_TOKEN is required when auth_mode=token."
            exit 1
          fi

      - name: Publish package (OIDC)
        if: ${{ ((steps.prepare_release.outputs.release_needed == 'true' || (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_only == 'true')) && steps.freshness.outputs.stale != 'true' && github.event.inputs.auth_mode != 'token') }}
        run: pnpm release
        env:
          NPM_CONFIG_PROVENANCE: true

      - name: Publish package (token fallback)
        if: ${{ ((steps.prepare_release.outputs.release_needed == 'true' || (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_only == 'true')) && steps.freshness.outputs.stale != 'true' && github.event.inputs.auth_mode == 'token') }}
        run: pnpm release
        env:
          NPM_CONFIG_PROVENANCE: true
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
