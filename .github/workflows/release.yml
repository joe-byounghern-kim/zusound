name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: Release tag to publish (example v0.2.3)
        required: true
        default: ''
      auth_mode:
        description: Publish auth mode (oidc or token)
        type: choice
        options:
          - oidc
          - token
        required: false
        default: oidc

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    environment:
      name: npm-publish
    permissions:
      contents: write
      id-token: write
      statuses: read

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22
          cache: pnpm
          registry-url: https://registry.npmjs.org

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: README sync check
        run: pnpm readme:check

      - name: Lint
        run: pnpm lint

      - name: Typecheck
        run: pnpm typecheck

      - name: Build
        run: pnpm build

      - name: Test Coverage
        run: pnpm test:coverage

      - name: Resolve release tag
        id: release_ctx
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${GITHUB_REF_NAME}"
          fi

          if [ -z "$TAG" ] || [[ "$TAG" != v* ]]; then
            echo "A valid release tag is required (example: v0.2.3)."
            exit 1
          fi

          VERSION="${TAG#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$TAG" ]; then
            echo "Unable to derive version from tag '$TAG'."
            exit 1
          fi

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            git fetch origin --tags
            if ! git rev-parse "refs/tags/$TAG" >/dev/null 2>&1; then
              echo "Tag '$TAG' does not exist on origin."
              exit 1
            fi
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Checkout release tag
        run: git checkout "${{ steps.release_ctx.outputs.tag }}"

      - name: Tag lineage guard
        id: lineage
        run: |
          git fetch origin main --tags
          TAG_SHA=$(git rev-list -n 1 "${{ steps.release_ctx.outputs.tag }}")
          if ! git merge-base --is-ancestor "$TAG_SHA" origin/main; then
            echo "Tag commit ($TAG_SHA) is not reachable from origin/main."
            exit 1
          fi

      - name: Verify tag matches package version
        id: package_version
        run: |
          PACKAGE_VERSION=$(node -e "console.log(JSON.parse(require('node:fs').readFileSync('packages/zusound/package.json', 'utf8')).version)")
          if [ "v${PACKAGE_VERSION}" != "${{ steps.release_ctx.outputs.tag }}" ]; then
            echo "Tag '${{ steps.release_ctx.outputs.tag }}' does not match package version 'v${PACKAGE_VERSION}'."
            exit 1
          fi
          echo "package_version=$PACKAGE_VERSION" >> "$GITHUB_OUTPUT"

      - name: Skip if version already published
        id: published_guard
        run: |
          PUBLISHED_VERSION=$(npm view zusound version 2>/dev/null || true)
          if [ "$PUBLISHED_VERSION" = "${{ steps.package_version.outputs.package_version }}" ]; then
            echo "Version $PUBLISHED_VERSION is already published. Skipping publish."
            echo "should_publish=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "should_publish=true" >> "$GITHUB_OUTPUT"

      - name: Validate token fallback secret
        if: ${{ steps.published_guard.outputs.should_publish == 'true' && github.event.inputs.auth_mode == 'token' }}
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -z "$NPM_TOKEN" ]; then
            echo "NPM_TOKEN is required when auth_mode=token."
            exit 1
          fi

      - name: Publish package (OIDC)
        if: ${{ steps.published_guard.outputs.should_publish == 'true' && github.event.inputs.auth_mode != 'token' }}
        run: pnpm release
        env:
          NPM_CONFIG_PROVENANCE: true

      - name: Publish package (token fallback)
        if: ${{ steps.published_guard.outputs.should_publish == 'true' && github.event.inputs.auth_mode == 'token' }}
        run: pnpm release
        env:
          NPM_CONFIG_PROVENANCE: true
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
